#!/bin/bash
# cognitive-core: secrets-store â€” add/update a secret in macOS Keychain
# Maps op:// reference format to Keychain service/account entries.
#
# Usage:
#   secrets-store <Vault/Item> <field>
#   secrets-store Development/Cloudflare api-token
#   secrets-store Development/Cloudflare account-id
#   secrets-store Development/GitHub-PAT multivac-pat
#
# You'll be prompted to paste the secret value (not echoed).
#
# This stores it so secrets-run can resolve op://Development/Cloudflare/api-token
# from Keychain instead of 1Password.
#
# To list stored secrets:
#   secrets-store --list
#
# To delete a secret:
#   secrets-store --delete <Vault/Item> <field>
#
set -euo pipefail

if [[ "${1:-}" == "--list" ]]; then
    echo "Secrets in Keychain (cognitive-core):"
    security dump-keychain 2>/dev/null | \
        grep -A4 '"svce".*"' | \
        grep -E '"svce"|"acct"' | \
        paste - - | \
        grep -E "Development/|Staging/|Production/" | \
        sed 's/.*"svce"<blob>="/  op:\/\//; s/".*"acct"<blob>="/\//; s/".*//' | \
        sort -u
    exit 0
fi

if [[ "${1:-}" == "--delete" ]]; then
    if [[ $# -lt 3 ]]; then
        echo "Usage: secrets-store --delete <Vault/Item> <field>" >&2
        exit 1
    fi
    service="$2"
    field="$3"
    security delete-generic-password -s "$service" -a "$field" 2>/dev/null && \
        echo "Deleted: op://$service/$field" || \
        echo "Not found: op://$service/$field" >&2
    exit 0
fi

if [[ $# -lt 2 ]]; then
    cat >&2 <<'USAGE'
Usage: secrets-store <Vault/Item> <field>

Examples:
  secrets-store Development/Cloudflare api-token
  secrets-store Development/Cloudflare account-id
  secrets-store Development/GitHub-PAT multivac-pat

Options:
  --list              List all stored secrets
  --delete <V/I> <f>  Delete a secret
USAGE
    exit 1
fi

SERVICE="$1"
FIELD="$2"

# Prompt for the value
printf "Enter value for op://%s/%s: " "$SERVICE" "$FIELD" >&2
IFS= read -rs value
echo >&2

if [[ -z "$value" ]]; then
    echo "Error: empty value, nothing stored" >&2
    exit 1
fi

# Add or update in Keychain (-U flag updates if exists)
security add-generic-password \
    -s "$SERVICE" \
    -a "$FIELD" \
    -w "$value" \
    -U \
    -l "cognitive-core: ${SERVICE}/${FIELD}" \
    -j "Managed by cognitive-core secrets-store"

echo "Stored: op://$SERVICE/$FIELD" >&2
