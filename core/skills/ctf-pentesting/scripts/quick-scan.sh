#!/bin/bash
# quick-scan.sh - Initial reconnaissance script for CTF challenges
# Usage: ./quick-scan.sh <target-ip> [port]
set -euo pipefail

TARGET="${1:?Usage: $0 <target-ip> [port]}"
PORT="${2:-}"

echo "╔══════════════════════════════════════╗"
echo "║  CTF Quick Scan - $(date +%H:%M:%S)          ║"
echo "║  Target: $TARGET                     "
echo "╚══════════════════════════════════════╝"
echo ""

# --- Phase 1: Port Scan ---
echo "=== PORT SCAN ==="
if [ -z "$PORT" ]; then
  nmap -sV --top-ports 1000 "$TARGET" 2>/dev/null | grep "^[0-9]"
else
  nmap -sV -p "$PORT" "$TARGET" 2>/dev/null | grep "^[0-9]"
fi
echo ""

# --- Phase 2: Web Enumeration (if web ports found) ---
for P in ${PORT:-80 443 3000 8080 8443}; do
  URL="http://${TARGET}:${P}"
  CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 2 "$URL" 2>/dev/null || echo "000")
  
  if [ "$CODE" != "000" ]; then
    echo "=== WEB: $URL [${CODE}] ==="
    
    # Headers
    echo "--- Headers ---"
    curl -sI "$URL" 2>/dev/null | grep -iE "server|powered|x-" || echo "(none)"
    
    # Info disclosure
    echo "--- Info Disclosure ---"
    for f in robots.txt .env .env.bak .git/config .git/HEAD package.json \
      sitemap.xml .htaccess wp-login.php; do
      C=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 2 "$URL/$f" 2>/dev/null)
      [ "$C" != "404" ] && [ "$C" != "000" ] && echo "  [${C}] /$f"
    done
    
    # HTML comments (non-standard)
    echo "--- HTML Comments ---"
    curl -s "$URL" 2>/dev/null | grep -oP '<!--(?![\$\-/\s]).*?-->' | head -5 || echo "(none)"
    
    echo ""
  fi
done

echo "=== SCAN COMPLETE ==="
echo "Next: gobuster dir -u http://${TARGET}:${PORT:-80} -w /usr/share/wordlists/dirb/common.txt -x php,txt,html,js,json -q | grep -v 'Status: 404'"
